---
import path from "node:path";

interface Props {
	id?: string;
	src: string;
	class?: string;
	alt?: string;
	position?: string;
	basePath?: string;
}

import { Image } from "astro:assets";
import { adaptImageUrlSync } from "../../utils/image-adapter";
import { url } from "../../utils/url-utils";

const { id, src, alt, position = "center", basePath = "/" } = Astro.props;
const className = Astro.props.class;

// 确保 src 是字符串，如果不是则使用空字符串
const srcString = typeof src === "string" ? src : "";

// 检查是否有有效的图片源
const hasValidSrc = srcString && srcString.trim() !== "";

const isLocal = !(
	srcString.startsWith("/") ||
	srcString.startsWith("http") ||
	srcString.startsWith("https") ||
	srcString.startsWith("data:")
);
const isPublic = srcString.startsWith("/");
const isNetwork = srcString.startsWith("http") || srcString.startsWith("https");

// TODO temporary workaround for images dynamic import
// https://github.com/withastro/astro/issues/3373
// biome-ignore lint/suspicious/noImplicitAnyLet: <check later>
let img;
if (isLocal) {
	const files = import.meta.glob<ImageMetadata>("../../**", {
		import: "default",
	});

	// 处理不同的路径格式
        let normalizedPath: string;
	if (srcString.startsWith("src/")) {
		// 如果路径以 src/ 开头，直接使用
		normalizedPath = path
			.normalize(path.join("../../", srcString))
			.replace(/\\/g, "/");
	} else if (srcString.startsWith("assets/")) {
		// 如果路径以 assets/ 开头，添加 src/ 前缀
		normalizedPath = path
			.normalize(path.join("../../src/", srcString))
			.replace(/\\/g, "/");
	} else {
		// 其他情况，使用 basePath
		normalizedPath = path
			.normalize(path.join("../../", basePath, srcString))
			.replace(/\\/g, "/");
	}

	// 只在开发模式下打印调试信息
	if (import.meta.env.DEV) {
		console.log(`🖼️ 尝试加载图片: ${normalizedPath}`);
		console.log(`🖼️ basePath: ${basePath}, srcString: ${srcString}`);
	}

	const file = files[normalizedPath];
	if (!file) {
		if (import.meta.env.DEV) {
			console.error(
				`\n[ERROR] Image file not found: ${normalizedPath.replace("../../", "src/")}`,
			);
			console.log("🖼️ 可用文件列表:", Object.keys(files).slice(0, 10));
		}
	} else {
		img = await file();
	}
}

const isBanner = id === "banner";
const imageClass = isBanner
	? "w-full h-full object-cover"
	: "w-full h-full object-cover";
const imageStyle = `object-position: ${position}`;
---
{hasValidSrc && (
<div id={id} class:list={[className, 'overflow-hidden relative image-loading-container']}>
    <!-- 加载动画覆盖层 -->
    <div class="image-loading-overlay">
        <span class="image-loading-text">LOADING</span>
    </div>
    
    <!-- 移除Banner的叠加层，保持其他图片的叠加层 -->
    {!isBanner && <div class="transition absolute inset-0 dark:bg-black/10 bg-opacity-50 pointer-events-none"></div>}

    {isLocal && img && <Image
        src={img}
        alt={alt || ""}
        class={`${imageClass} astro-image`}
        style={imageStyle}
        quality={isBanner ? 95 : 80}
        format="webp"
        loading={isBanner ? "eager" : "lazy"}
        decoding={isBanner ? "sync" : "async"}
        width={isBanner ? 1920 : undefined}
        height={isBanner ? 1080 : undefined}
    />}
    {!isLocal && <img
        src={adaptImageUrlSync(srcString)}
        alt={alt || ""}
        class={imageClass}
        style={imageStyle}
        loading={isBanner ? "eager" : "lazy"}
        decoding={isBanner ? "sync" : "async"}
        crossorigin={isNetwork ? "anonymous" : undefined}
        referrerpolicy={isNetwork ? "no-referrer-when-downgrade" : undefined}
        onload="this.parentElement.classList.add('image-loaded')"
    />}
</div>
)}

<script>
  // 处理图片加载完成事件
  document.addEventListener('DOMContentLoaded', function() {
    // 处理普通img标签
    const images = document.querySelectorAll('img:not(.astro-image)');
    images.forEach(img => {
      if (img.complete) {
        img.parentElement?.classList.add('image-loaded');
      } else {
        img.addEventListener('load', function() {
          this.parentElement?.classList.add('image-loaded');
        });
      }
    });
    
    // 处理Astro Image组件生成的图片
    const astroImages = document.querySelectorAll('.astro-image');
    astroImages.forEach(img => {
      if (img.complete) {
        img.parentElement?.classList.add('image-loaded');
      } else {
        img.addEventListener('load', function() {
          this.parentElement?.classList.add('image-loaded');
        });
      }
    });
    
    // 使用MutationObserver监听动态添加的图片
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.addedNodes.forEach(function(node) {
          if (node.nodeType === 1) { // Element node
            const images = node.querySelectorAll ? node.querySelectorAll('img') : [];
            images.forEach(img => {
              if (img.complete) {
                img.parentElement?.classList.add('image-loaded');
              } else {
                img.addEventListener('load', function() {
                  this.parentElement?.classList.add('image-loaded');
                });
              }
            });
          }
        });
      });
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  });
</script>
